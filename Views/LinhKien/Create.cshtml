@model phonev2.Models.LinhKien
@{
    Layout = "_AdminLayout";
}

@section PageActions {
    <a asp-action="Index" class="btn btn-secondary">
        <i class="fas fa-arrow-left me-1"></i> Quay Lại Danh Sách
    </a>
}

<div class="row justify-content-center">
    <div class="col-lg-10">
        <div class="card shadow">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Thêm Linh Kiện Mới
                </h5>
            </div>
            <div class="card-body">
                <form asp-action="Create" method="post" novalidate>
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger" role="alert"></div>
                    
                    <!-- Row 1: Tên linh kiện và Loại -->
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label asp-for="TenLinhKien" class="form-label fw-bold">
                                <i class="fas fa-microchip me-1 text-primary"></i>
                                @Html.DisplayNameFor(model => model.TenLinhKien)
                                <span class="text-danger">*</span>
                            </label>
                            <input asp-for="TenLinhKien" class="form-control form-control-lg" 
                                   placeholder="VD: RAM DDR4 8GB Kingston, CPU Intel Core i5-11400..." 
                                   autocomplete="off" />
                            <span asp-validation-for="TenLinhKien" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="MaLoaiLinhKien" class="form-label fw-bold">
                                <i class="fas fa-tags me-1 text-info"></i>
                                @Html.DisplayNameFor(model => model.MaLoaiLinhKien)
                                <span class="text-danger">*</span>
                            </label>
                            <select asp-for="MaLoaiLinhKien" class="form-select form-select-lg" asp-items="ViewBag.LoaiLinhKienList">
                                <option value="">-- Chọn loại linh kiện --</option>
                            </select>
                            <span asp-validation-for="MaLoaiLinhKien" class="text-danger"></span>
                        </div>
                    </div>

                    <!-- Row 2: Hãng sản xuất và Thông số kỹ thuật -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label asp-for="HangSanXuat" class="form-label fw-bold">
                                <i class="fas fa-industry me-1 text-secondary"></i>
                                @Html.DisplayNameFor(model => model.HangSanXuat)
                            </label>
                            <input asp-for="HangSanXuat" class="form-control" 
                                   placeholder="VD: Kingston, Samsung, Intel, AMD..." 
                                   list="brandSuggestions" autocomplete="off" />
                            <datalist id="brandSuggestions">
                                <option value="Kingston"></option>
                                <option value="Samsung"></option>
                                <option value="Intel"></option>
                                <option value="AMD"></option>
                                <option value="ASUS"></option>
                                <option value="MSI"></option>
                                <option value="Gigabyte"></option>
                                <option value="Corsair"></option>
                                <option value="G.Skill"></option>
                                <option value="Western Digital"></option>
                                <option value="Seagate"></option>
                                <option value="NVIDIA"></option>
                            </datalist>
                            <span asp-validation-for="HangSanXuat" class="text-danger"></span>
                        </div>
                        
                        <div class="col-md-8">
                            <label asp-for="ThongSoKyThuat" class="form-label fw-bold">
                                <i class="fas fa-cogs me-1 text-info"></i>
                                @Html.DisplayNameFor(model => model.ThongSoKyThuat)
                            </label>
                            <textarea asp-for="ThongSoKyThuat" class="form-control" rows="3" 
                                      placeholder="VD: DDR4-3200, CL16, 1.35V, Non-ECC, Unbuffered..."></textarea>
                            <span asp-validation-for="ThongSoKyThuat" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Thông số kỹ thuật chi tiết giúp khách hàng hiểu rõ hơn về sản phẩm
                            </div>
                        </div>
                    </div>

                    <!-- Row 3: Giá nhập, Giá bán và Số lượng -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label asp-for="GiaNhap" class="form-label fw-bold">
                                <i class="fas fa-file-import me-1 text-warning"></i>
                                @Html.DisplayNameFor(model => model.GiaNhap)
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="GiaNhap" class="form-control" 
                                       placeholder="0" 
                                       type="number" 
                                       step="1000"
                                       min="0" />
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <span asp-validation-for="GiaNhap" class="text-danger"></span>
                            <div class="mt-1" id="costDisplay" style="display: none;">
                                <small class="text-warning fw-bold" id="formattedCost">0 VNĐ</small>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="GiaBan" class="form-label fw-bold">
                                <i class="fas fa-tag me-1 text-success"></i>
                                @Html.DisplayNameFor(model => model.GiaBan)
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="GiaBan" class="form-control" 
                                       placeholder="0" 
                                       type="number" 
                                       step="1000"
                                       min="0" />
                                <span class="input-group-text">VNĐ</span>
                            </div>
                            <span asp-validation-for="GiaBan" class="text-danger"></span>
                            <div class="mt-1" id="priceDisplay" style="display: none;">
                                <small class="text-success fw-bold" id="formattedPrice">0 VNĐ</small>
                            </div>
                        </div>
                        
                        <div class="col-md-4">
                            <label asp-for="SoLuongTon" class="form-label fw-bold">
                                <i class="fas fa-boxes me-1 text-primary"></i>
                                @Html.DisplayNameFor(model => model.SoLuongTon)
                                <span class="text-danger">*</span>
                            </label>
                            <div class="input-group">
                                <input asp-for="SoLuongTon" class="form-control" 
                                       placeholder="0" 
                                       type="number" 
                                       min="0" />
                                <span class="input-group-text">cái</span>
                            </div>
                            <span asp-validation-for="SoLuongTon" class="text-danger"></span>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Số lượng hiện có trong kho
                            </div>
                        </div>
                    </div>

                    <!-- Row 4: Lợi nhuận tính toán -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-calculator me-1 text-info"></i>
                                Phân Tích Lợi Nhuận
                            </label>
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="row text-center">
                                        <div class="col-4">
                                            <div class="border-end">
                                                <h5 class="text-success mb-1" id="profitAmount">0 VNĐ</h5>
                                                <small class="text-muted">Lợi nhuận/cái</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <div class="border-end">
                                                <h5 class="text-primary mb-1" id="profitPercent">0%</h5>
                                                <small class="text-muted">Tỷ lệ lợi nhuận</small>
                                            </div>
                                        </div>
                                        <div class="col-4">
                                            <h5 class="text-warning mb-1" id="totalProfit">0 VNĐ</h5>
                                            <small class="text-muted">Lợi nhuận tổng</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label fw-bold">
                                <i class="fas fa-lightbulb me-1 text-warning"></i>
                                Gợi Ý Giá Bán
                            </label>
                            <div class="bg-light p-3 rounded">
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Lợi nhuận 20%:</span>
                                    <strong class="text-success" id="suggest20">0 VNĐ</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span>Lợi nhuận 30%:</span>
                                    <strong class="text-warning" id="suggest30">0 VNĐ</strong>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Lợi nhuận 50%:</span>
                                    <strong class="text-danger" id="suggest50">0 VNĐ</strong>
                                </div>
                                <hr class="my-2">
                                <div class="d-grid gap-2">
                                    <div class="btn-group btn-group-sm">
                                        <button type="button" class="btn btn-outline-success apply-suggestion" data-percent="20">Áp dụng 20%</button>
                                        <button type="button" class="btn btn-outline-warning apply-suggestion" data-percent="30">Áp dụng 30%</button>
                                        <button type="button" class="btn btn-outline-danger apply-suggestion" data-percent="50">Áp dụng 50%</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Row 5: Trạng thái -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">
                                <i class="fas fa-toggle-on me-1 text-primary"></i>
                                Trạng Thái
                            </label>
                            <div class="form-check form-switch">
                                <input asp-for="TrangThai" class="form-check-input" type="checkbox" 
                                       id="trangThaiSwitch" checked />
                                <label class="form-check-label" for="trangThaiSwitch">
                                    <span class="switch-label">Linh kiện đang được bán</span>
                                </label>
                            </div>
                            <div class="form-text">
                                <i class="fas fa-info-circle me-1"></i>
                                Chỉ những linh kiện đang hoạt động mới hiển thị trong danh sách bán hàng
                            </div>
                        </div>
                    </div>

                    <!-- Preview Card -->
                    <div class="row mb-4">
                        <div class="col-md-12">
                            <label class="form-label fw-bold">
                                <i class="fas fa-eye me-1 text-secondary"></i>
                                Xem Trước Linh Kiện
                            </label>
                            <div class="card border-2 border-dashed" id="previewCard">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col-md-6">
                                            <h6 class="card-title mb-1" id="previewName">
                                                <i class="fas fa-microchip me-2"></i>
                                                <span class="text-muted">Tên linh kiện sẽ hiển thị ở đây</span>
                                            </h6>
                                            <p class="card-text text-muted mb-1" id="previewBrand">
                                                <i class="fas fa-industry me-1"></i>
                                                <span>Hãng sản xuất</span>
                                            </p>
                                            <p class="card-text text-muted mb-0" id="previewCategory">
                                                <i class="fas fa-tags me-1"></i>
                                                <span>Loại linh kiện</span>
                                            </p>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="price-display">
                                                <h4 class="text-success mb-0" id="previewPrice">0 VNĐ</h4>
                                                <small class="text-muted" id="previewCost">Giá nhập: 0 VNĐ</small>
                                            </div>
                                        </div>
                                        <div class="col-md-3 text-center">
                                            <div class="stock-display">
                                                <span class="badge bg-info fs-6 px-3 py-2" id="previewStock">
                                                    <i class="fas fa-boxes me-1"></i>
                                                    <span>0 cái</span>
                                                </span>
                                                <br>
                                                <small class="text-muted" id="previewStockStatus">Tình trạng kho</small>
                                            </div>
                                        </div>
                                    </div>
                                    <hr>
                                    <div class="row" id="previewSpecs" style="display: none;">
                                        <div class="col-12">
                                            <strong class="text-muted">Thông số kỹ thuật:</strong>
                                            <p class="mb-0" id="previewSpecsText"></p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a asp-action="Index" class="btn btn-secondary btn-lg me-md-2">
                            <i class="fas fa-times me-1"></i>
                            Hủy Bỏ
                        </a>
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-save me-1"></i>
                            Lưu Linh Kiện
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    
    <script>
        $(document).ready(function() {
            
            // Format number with dots (Vietnamese style)
            function formatCurrency(num) {
                if (!num || num == 0) return '0 VNĐ';
                return parseInt(num).toLocaleString('vi-VN') + ' VNĐ';
            }
            
            // Update price displays
            function updatePriceDisplays() {
                const costPrice = parseFloat($('#GiaNhap').val()) || 0;
                const sellPrice = parseFloat($('#GiaBan').val()) || 0;
                const quantity = parseInt($('#SoLuongTon').val()) || 0;
                
                // Format and show prices
                if (costPrice > 0) {
                    $('#formattedCost').text(formatCurrency(costPrice));
                    $('#costDisplay').fadeIn(200);
                } else {
                    $('#costDisplay').fadeOut(200);
                }
                
                if (sellPrice > 0) {
                    $('#formattedPrice').text(formatCurrency(sellPrice));
                    $('#priceDisplay').fadeIn(200);
                } else {
                    $('#priceDisplay').fadeOut(200);
                }
                
                // Calculate profit
                const profit = sellPrice - costPrice;
                const profitPercent = costPrice > 0 ? Math.round((profit / costPrice) * 100) : 0;
                const totalProfit = profit * quantity;
                
                $('#profitAmount').text(formatCurrency(profit));
                $('#profitPercent').text(profitPercent + '%');
                $('#totalProfit').text(formatCurrency(totalProfit));
                
                // Update profit colors
                $('#profitAmount').removeClass('text-success text-danger text-muted')
                    .addClass(profit > 0 ? 'text-success' : profit < 0 ? 'text-danger' : 'text-muted');
                
                // Update suggestions
                if (costPrice > 0) {
                    $('#suggest20').text(formatCurrency(costPrice * 1.2));
                    $('#suggest30').text(formatCurrency(costPrice * 1.3));
                    $('#suggest50').text(formatCurrency(costPrice * 1.5));
                }
            }
            
            // Real-time preview
            function updatePreview() {
                const name = $('#TenLinhKien').val() || 'Tên linh kiện sẽ hiển thị ở đây';
                const brand = $('#HangSanXuat').val() || 'Chưa có hãng sản xuất';
                const categoryText = $('#MaLoaiLinhKien option:selected').text() || 'Chưa chọn loại';
                const specs = $('#ThongSoKyThuat').val();
                const sellPrice = parseFloat($('#GiaBan').val()) || 0;
                const costPrice = parseFloat($('#GiaNhap').val()) || 0;
                const quantity = parseInt($('#SoLuongTon').val()) || 0;
                
                $('#previewName span').text(name);
                $('#previewBrand span').text(brand);
                $('#previewCategory span').text(categoryText);
                $('#previewPrice').text(formatCurrency(sellPrice));
                $('#previewCost').text('Giá nhập: ' + formatCurrency(costPrice));
                $('#previewStock span').text(quantity + ' cái');
                
                // Update stock status
                let stockStatus, stockClass;
                if (quantity === 0) {
                    stockStatus = 'Hết hàng';
                    stockClass = 'bg-danger';
                } else if (quantity <= 5) {
                    stockStatus = 'Sắp hết';
                    stockClass = 'bg-warning';
                } else if (quantity <= 20) {
                    stockStatus = 'Ít hàng';
                    stockClass = 'bg-info';
                } else {
                    stockStatus = 'Còn nhiều';
                    stockClass = 'bg-success';
                }
                
                $('#previewStockStatus').text(stockStatus);
                $('#previewStock').attr('class', `badge ${stockClass} fs-6 px-3 py-2`);
                
                // Show/hide specs
                if (specs && specs.trim()) {
                    $('#previewSpecsText').text(specs);
                    $('#previewSpecs').slideDown(300);
                } else {
                    $('#previewSpecs').slideUp(300);
                }
                
                updatePriceDisplays();
            }
            
            // Update preview on input change
            $('#TenLinhKien, #HangSanXuat, #MaLoaiLinhKien, #ThongSoKyThuat, #GiaNhap, #GiaBan, #SoLuongTon').on('input change', updatePreview);
            
            // Price formatting
            $('#GiaNhap, #GiaBan').on('input', updatePriceDisplays);
            
            // Apply suggestion buttons
            $('.apply-suggestion').on('click', function() {
                const percent = parseFloat($(this).data('percent'));
                const costPrice = parseFloat($('#GiaNhap').val()) || 0;
                
                if (costPrice > 0) {
                    const suggestedPrice = Math.round(costPrice * (1 + percent / 100));
                    $('#GiaBan').val(suggestedPrice);
                    updatePreview();
                }
            });
            
            // Switch label change
            $('#trangThaiSwitch').on('change', function() {
                const label = $(this).is(':checked') ? 'Linh kiện đang được bán' : 'Linh kiện ngừng bán';
                $('.switch-label').text(label);
            });
            
            // Auto-focus first field
            $('#TenLinhKien').focus();
            
            // Initial preview update
            updatePreview();
            
            // Form validation enhancement
            $('form').on('submit', function(e) {
                const costPrice = parseFloat($('#GiaNhap').val()) || 0;
                const sellPrice = parseFloat($('#GiaBan').val()) || 0;
                
                if (sellPrice < costPrice) {
                    e.preventDefault();
                    alert('Cảnh báo: Giá bán thấp hơn giá nhập. Bạn sẽ bị lỗ!');
                    $('#GiaBan').focus();
                    return false;
                }
                
                if (costPrice > 0 && sellPrice > costPrice * 3) {
                    if (!confirm('Giá bán cao hơn 300% giá nhập. Bạn có chắc chắn?')) {
                        e.preventDefault();
                        $('#GiaBan').focus();
                        return false;
                    }
                }
            });
        });
    </script>
}