@model phonev2.Models.ViewModels.PhieuSuaCreateViewModel
@{
    ViewData["Title"] = "Thêm Phiếu Sửa";
    Layout = "~/Views/Shared/_AdminLayout.cshtml";
    // Render option dịch vụ với data-gia nếu có
    var dichVuOptions = string.Join("", Model.DichVuList.Select(dv => $"<option value='{dv.Value}' data-gia='{(dv is Microsoft.AspNetCore.Mvc.Rendering.SelectListItem sl && sl.Value != null && sl.Text != null && decimal.TryParse(sl.Text, out var gia) ? gia.ToString() : "0")}'>{dv.Text}</option>"));
}

<h2 class="mb-4">Thêm Phiếu Sửa</h2>
<form asp-action="Create" method="post">
    <div class="row">
        <div class="col-md-6">
            <div class="mb-3">
                <label asp-for="PhieuSua.NgaySua" class="form-label">Ngày Sửa</label>
                <input asp-for="PhieuSua.NgaySua" class="form-control" type="date" required />
                <span asp-validation-for="PhieuSua.NgaySua" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="PhieuSua.NgayHenTra" class="form-label">Ngày Hẹn Trả</label>
                <input asp-for="PhieuSua.NgayHenTra" class="form-control" type="datetime-local" />
                <span asp-validation-for="PhieuSua.NgayHenTra" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="PhieuSua.MaKhachHang" class="form-label">Khách Hàng</label>
                <div class="input-group">
                    <select asp-for="PhieuSua.MaKhachHang" class="form-select" asp-items="Model.KhachHangList" id="khachHangDropdown">
                        <option value="">-- Chọn khách hàng --</option>
                    </select>
                    <button type="button" class="btn btn-outline-primary" id="btnAddKhachHang" tabindex="-1">
                        <i class="fas fa-user-plus"></i> Thêm khách hàng mới
                    </button>
                </div>
                <span asp-validation-for="PhieuSua.MaKhachHang" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="PhieuSua.MaNhanVien" class="form-label">Nhân Viên</label>
                <select asp-for="PhieuSua.MaNhanVien" class="form-select" asp-items="Model.NhanVienList">
                    <option value="">-- Chọn nhân viên --</option>
                </select>
                <span asp-validation-for="PhieuSua.MaNhanVien" class="text-danger"></span>
            </div>
            <div class="mb-3">
                <label asp-for="PhieuSua.GhiChu" class="form-label">Ghi chú</label>
                <textarea asp-for="PhieuSua.GhiChu" class="form-control"></textarea>
            </div>
            <div class="mb-3">
                <label asp-for="PhieuSua.TrangThai" class="form-label">Trạng thái</label>
                <select asp-for="PhieuSua.TrangThai" class="form-select">
                    <option value="0">Tiếp nhận</option>
                    <option value="1">Đang sửa</option>
                    <option value="2">Hoàn thành</option>
                    <option value="3">Hủy</option>
                </select>
            </div>
        </div>
        <div class="col-md-6">
            <h5>Dịch Vụ</h5>
            <div id="dichvu-list">
                <div class="row mb-2 dichvu-row">
                    <div class="col-10">
                        <select name="DichVus[0].MaDichVu" class="form-select dichvu-select" required>
                            <option value="">-- Chọn dịch vụ --</option>
                            @Html.Raw(dichVuOptions)
                        </select>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-success btn-add-dv">+</button>
                    </div>
                </div>
            </div>
            <hr />
            <h5>Linh Kiện</h5>
            <div id="linhkien-list">
                <div class="row mb-2 linhkien-row">
                    <div class="col-6">
                        <select name="LinhKiens[0].MaLinhKien" class="form-select linhkien-select" required>
                            <option value="">-- Chọn linh kiện --</option>
                        </select>
                    </div>
                    <div class="col-4">
                        <input type="number" name="LinhKiens[0].SoLuong" class="form-control" value="1" min="1" required />
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-success btn-add-lk">+</button>
                    </div>
                </div>
            </div>
            <div class="mt-3">
                <div class="alert alert-info">
                    <div>Giá dịch vụ: <span id="giaDichVu">0</span> VNĐ</div>
                    <div>Giá linh kiện: <span id="giaLinhKien">0</span> VNĐ</div>
                    <div class="fw-bold">Tổng tiền phiếu sửa: <span id="tongTienPhieuSua">0</span> VNĐ</div>
                </div>
            </div>
        </div>
    </div>
    <div class="mt-4 text-end">
        <button type="submit" class="btn btn-primary">Lưu Phiếu Sửa</button>
        <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>
</form>

<div class="modal fade" id="addKhachHangModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content"></div>
  </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Lưu HTML option dịch vụ sẵn
        const dichVuOptions = `@Html.Raw(dichVuOptions)`;

        // Thêm dòng dịch vụ
        $(document).on('click', '.btn-add-dv', function () {
            let idx = $('#dichvu-list .dichvu-row').length;
            let html = `<div class="row mb-2 dichvu-row">
                <div class="col-10">
                    <select name="DichVus[${idx}].MaDichVu" class="form-select dichvu-select" required>
                        <option value="">-- Chọn dịch vụ --</option>
                        ${dichVuOptions}
                    </select>
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-danger btn-remove-dv">-</button>
                </div>
            </div>`;
            $('#dichvu-list').append(html);
        });
        $(document).on('click', '.btn-remove-dv', function () {
            $(this).closest('.dichvu-row').remove();
            updateDvIndexes();
            updateTongTien();
        });
        function updateDvIndexes() {
            $('#dichvu-list .dichvu-row').each(function (i) {
                $(this).find('select').attr('name', `DichVus[${i}].MaDichVu`);
            });
        }

        // Thêm dòng linh kiện
        $(document).on('click', '.btn-add-lk', function () {
            let idx = $('#linhkien-list .linhkien-row').length;
            let html = `<div class="row mb-2 linhkien-row">
                <div class="col-6">
                    <select name="LinhKiens[${idx}].MaLinhKien" class="form-select linhkien-select" required>
                        <option value="">-- Chọn linh kiện --</option>
                    </select>
                </div>
                <div class="col-4">
                    <input type="number" name="LinhKiens[${idx}].SoLuong" class="form-control" value="1" min="1" required />
                </div>
                <div class="col-2">
                    <button type="button" class="btn btn-danger btn-remove-lk">-</button>
                </div>
            </div>`;
            $('#linhkien-list').append(html);
        });
        $(document).on('click', '.btn-remove-lk', function () {
            $(this).closest('.linhkien-row').remove();
            updateLkIndexes();
            updateTongTien();
        });
        function updateLkIndexes() {
            $('#linhkien-list .linhkien-row').each(function (i) {
                $(this).find('select').attr('name', `LinhKiens[${i}].MaLinhKien`);
                $(this).find('input[type=number]').attr('name', `LinhKiens[${i}].SoLuong`);
            });
        }

        // Khi chọn dịch vụ, load linh kiện thuộc dịch vụ đó
        $(document).on('change', '.dichvu-select', function () {
            var maDichVu = $(this).val();
            var $lkSelects = $('.linhkien-select');
            if (!maDichVu) {
                $lkSelects.html('<option value="">-- Chọn linh kiện --</option>');
                updateTongTien();
                return;
            }
            $.get('/DichVu/GetLinhKienByDichVu', { maDichVu: maDichVu }, function (data) {
                var options = '<option value="">-- Chọn linh kiện --</option>';
                data.forEach(function (lk) {
                    options += `<option value="${lk.maLinhKien}" data-giaban="${lk.giaBan || 0}">${lk.tenLinhKien}${lk.giaBan ? ' (' + lk.giaBan.toLocaleString('vi-VN') + ' VNĐ)' : ''}</option>`;
                });
                $lkSelects.html(options);
                updateTongTien();
            });
        });

        // Khi chọn dịch vụ hoặc linh kiện, hoặc thay đổi số lượng, cập nhật tổng tiền
        $(document).on('change', '.dichvu-select, .linhkien-select', updateTongTien);
        $(document).on('input', '.linhkien-row input[type=number]', updateTongTien);

        function updateTongTien() {
            // Tổng giá dịch vụ
            let tongDichVu = 0;
            $('.dichvu-select').each(function () {
                let gia = parseFloat($(this).find('option:selected').data('gia')) || 0;
                tongDichVu += gia;
            });
            // Tổng giá linh kiện
            let tongLinhKien = 0;
            $('.linhkien-row').each(function () {
                let $select = $(this).find('.linhkien-select');
                let giaBan = parseFloat($select.find('option:selected').data('giaban')) || 0;
                let soLuong = parseInt($(this).find('input[type=number]').val()) || 1;
                tongLinhKien += giaBan * soLuong;
            });
            $('#giaDichVu').text(tongDichVu.toLocaleString('vi-VN'));
            $('#giaLinhKien').text(tongLinhKien.toLocaleString('vi-VN'));
            $('#tongTienPhieuSua').text((tongDichVu + tongLinhKien).toLocaleString('vi-VN'));
        }
        // Gọi lần đầu khi load
        $(function(){ updateTongTien(); });

        $(function() {
            // Mở modal thêm khách hàng
            $('#btnAddKhachHang').click(function() {
                $('#addKhachHangModal .modal-content').html('<div class="text-center p-5"><div class="spinner-border"></div></div>');
                $('#addKhachHangModal').modal('show');
                $.get('/KhachHang/CreateQuick', function(html) {
                    $('#addKhachHangModal .modal-content').html(html);
                });
            });

            // Submit form thêm khách hàng qua AJAX
            $(document).on('submit', '#quickAddKhachHangForm', function(e) {
                e.preventDefault();
                var $form = $(this);
                $.ajax({
                    url: '/KhachHang/CreateQuick',
                    method: 'POST',
                    data: $form.serialize(),
                    success: function(res) {
                        if (res.success) {
                            // Đóng modal
                            $('#addKhachHangModal').modal('hide');
                            // Reload dropdown khách hàng
                            $.get('/KhachHang/GetActiveCustomers', function(data) {
                                var $dropdown = $('#khachHangDropdown');
                                $dropdown.empty();
                                $dropdown.append('<option value="">-- Chọn khách hàng --</option>');
                                $.each(data, function(i, kh) {
                                    $dropdown.append('<option value="' + kh.value + '">' + kh.text + '</option>');
                                });
                                // Chọn khách hàng vừa tạo
                                $dropdown.val(res.id);
                            });
                        } else {
                            // Hiển thị lại form với lỗi
                            $('#addKhachHangModal .modal-content').html(res);
                        }
                    }
                });
            });
        });
    </script>
} 